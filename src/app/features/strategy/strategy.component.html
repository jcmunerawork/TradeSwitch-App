<div class="regularText color-background">
  @if (initialLoading || isProcessingStrategy) {
  <!-- Loading State -->
  <app-loading-spinner 
    title="Loading your strategies..." 
    description="Please wait while we load your strategies.">
  </app-loading-spinner>
  } @else {
  <!-- Main Content -->
  <div class="mb-20 d-flex justify-between">
    <div>
      <h2 class="titleText mb-16">My Strategy</h2>
      <p>Design a strategy that supports your consistency with TradeSwitch.</p>
    </div>
  </div>
  <!-- Control Bar -->
  <div class="control-bar mb-4">
    <!-- Search Input -->
    <div class="search-container">
      <div class="search-input-wrapper">
        <span class="material-symbols-outlined search-icon" style="font-size: 20px;">search</span>
        <app-text-input
          placeholder="Search by name"
          [label]="''"
          (input)="onSearchChange($event)"
          class="search-input"
        ></app-text-input>
      </div>
    </div>
    
    <!-- Filter Button (commented out) -->
    <!-- <button class="filter-btn d-flex align-items-center gap-8">
      <span class="icon-filter"></span>
      <span>Filter</span>
    </button> -->
    
    <!-- New Strategy Button -->
    <button 
      class="add-strategy-btn d-flex align-items-center gap-8" 
      [class.disabled]="isAddStrategyDisabled"
      [disabled]="isAddStrategyDisabled"
      (click)="isAddStrategyDisabled ? null : onNewStrategy()"
    >
      <span class="material-symbols-outlined" style="font-size: 20px;">add</span>
      <span>Add Strategy</span>
    </button>
  </div>


  <!-- Plan Banner -->
  @if (showPlanBanner) {
  <app-plan-banner
    [visible]="showPlanBanner"
    [message]="planBannerMessage"
    [type]="planBannerType"
    (upgradePlan)="onUpgradePlan()"
    (closeBanner)="onCloseBanner()"
  ></app-plan-banner>
  }

  <!-- Primera validación: ¿Existe alguna estrategia en general? -->
  @if (userStrategies.length === 0 && !activeStrategy && accountsData.length > 0) {
  <!-- No hay estrategias en absoluto, pero hay cuentas -->
  <div class="empty-strategies d-flex flex-col align-items-center">
    <div class="empty-icon">
      <span class="material-symbols-outlined" style="font-size: 28px;">content_paste_search</span>
    </div>
    <h3 class="empty-title">No strategies found</h3>
    <p class="empty-description">Create your first strategy to start trading with TradeSwitch.</p>
    <button class="create-first-btn" (click)="onNewStrategy()">
      Create First Strategy
    </button>
  </div>
  } @else if (accountsData.length > 0) {
  <!-- Hay al menos una estrategia, mostrar la activa -->
  @if (activeStrategy) {
  <div class="active-strategy d-flex flex-col mb-20">
    <h3 class="section-title">Active Strategy</h3>
    <p class="section-description">Currently active strategy configuration.</p>
    
    <!-- Active Strategy Grid - Always 2 columns, but only left column filled -->
    <div class="active-strategy-grid">
      <div class="active-strategy-card">
        <app-strategy-card
          [strategy]="strategyCard"
          [showCustomizeButton]="true"
          customizeButtonText="Customize strategy"
          (edit)="onStrategyEdit($event)"
          (favorite)="onStrategyFavorite($event)"
          (moreOptions)="onStrategyMoreOptions($event)"
          (customize)="onStrategyCustomize($event)"
          (duplicate)="copyStrategy($event)"
          (delete)="deleteStrategy($event)"
        ></app-strategy-card>
      </div>
      <!-- Empty space for right column -->
      <div class="empty-strategy-slot"></div>
    </div>
  </div>
  }

  <!-- Other Strategies Section - Only show if plan allows multiple strategies -->
  @if (canCreateMultipleStrategies()) {
    @if (userStrategies.length > 0) {
    <!-- Hay otras estrategias, mostrar las cards -->
    <div class="other-strategies d-flex flex-col">
      <h3 class="section-title">Other Strategies</h3>
      <p class="section-description">Manage your other strategy configurations.</p>
      
      <div class="strategies-grid">
        @for (strategy of filteredStrategies; track getStrategyId(strategy)) {
          @if (!strategy.status) {
          <app-strategy-card
            [strategy]="getCardDataByStrategyId(getStrategyId(strategy)) || {
              id: getStrategyId(strategy),
              name: strategy.name,
              status: false,
              lastModified: formatDate(strategy.updated_at.toDate()),
              rules: 0,
              days_active: strategy.days_active || 0,
              winRate: 0,
              isFavorite: false,
              created_at: strategy.created_at,
              updated_at: strategy.updated_at,
              userId: strategy.userId,
              configurationId: strategy.configurationId
            }"
            [showCustomizeButton]="true"
            customizeButtonText="Activate strategy"
            (edit)="onStrategyEdit($event)"
            (favorite)="onStrategyFavorite($event)"
            (moreOptions)="onStrategyMoreOptions($event)"
            (customize)="activateStrategy($event)"
            (duplicate)="copyStrategy($event)"
            (delete)="deleteStrategy($event)"
          ></app-strategy-card>
          }
        }
      </div>
    </div>
    } @else if (activeStrategy && userStrategies.length === 0) {
    <!-- Solo tiene la estrategia activa y puede añadir más -->
    <div class="other-strategies d-flex flex-col">
      <h3 class="section-title">Other Strategies</h3>
      <p class="section-description">You can add more strategies to your plan.</p>
      
      <div class="empty-strategies d-flex flex-col align-items-center">
        <div class="empty-icon">
          <span class="material-symbols-outlined" style="font-size: 28px;">add_circle</span>
        </div>
        <h3 class="empty-title">Add more strategies</h3>
        <p class="empty-description">Your plan allows you to create additional strategies.</p>
        <button class="create-first-btn" (click)="onNewStrategy()" [disabled]="isAddStrategyDisabled">
          Create Additional Strategy
        </button>
      </div>
    </div>
    }
  } @else {
  <!-- Plan Free - Show upgrade message -->
  <div class="other-strategies d-flex flex-col">
    <h3 class="section-title">Other Strategies</h3>
    <p class="section-description">Upgrade your plan to create multiple strategies.</p>
    
    <div class="empty-strategies d-flex flex-col align-items-center">
      <div class="empty-icon">
        <span class="material-symbols-outlined" style="font-size: 28px; color: #9BF526;">lock</span>
      </div>
      <h3 class="empty-title">Upgrade to create more strategies</h3>
      <p class="empty-description">Your Free plan allows only 1 strategy. Upgrade to Starter or Pro for more.</p>
      <button class="create-first-btn" (click)="onUpgradePlan()">
        Upgrade Plan
      </button>
    </div>
  </div>
  }
  }

  <!-- Validaciones adicionales para casos especiales -->
  @if (accountsData.length === 0 && userStrategies.length === 0 && !activeStrategy) {
  <div class="empty-strategies d-flex flex-col align-items-center">
    <div class="empty-icon">
      <span class="material-symbols-outlined" style="font-size: 28px;">group_add</span>
    </div>
    <h3 class="empty-title">No trading accounts found</h3>
    <p class="empty-description">You need to add a trading account before creating strategies.</p>
    <button class="create-first-btn" (click)="navigateToTradingAccounts()">
      Add Trading Account
    </button>
  </div>
  }

  @if (filteredStrategies.length === 0 && searchTerm && userStrategies.length > 0) {
  <div class="empty-strategies d-flex flex-col align-items-center">
    <div class="empty-icon">
      <span class="material-symbols-outlined" style="font-size: 28px;">search</span>
    </div>
    <h3 class="empty-title">No strategies found</h3>
    <p class="empty-description">No strategies match your search criteria.</p>
    <button class="create-first-btn" (click)="searchTerm = ''; filterStrategies()">
      Clear search
    </button>
  </div>
  }
}

<!-- Strategy Guide Modal -->
@if (showStrategyGuide) {
<app-strategy-guide-modal
  (closeModal)="onCloseStrategyGuide()"
  (dontShowAgain)="onDontShowStrategyGuideAgain()"
  (editStrategy)="onEditStrategyFromGuide()"
></app-strategy-guide-modal>
}

<!-- Loading overlay for strategy creation -->
@if (isCreatingStrategy) {
<div class="strategy-creation-loading-overlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p class="loading-text">Creating strategy...</p>
  </div>
</div>
}

<!-- Delete strategy confirmation popup -->
<app-confirm-popup
  [visible]="showDeleteConfirmPopup"
  [close]="confirmDeleteStrategy"
  [cancel]="cancelDeleteStrategy"
  [title]="'Delete strategy?'"
  [message]="'Are you sure you want to delete this strategy? This action cannot be undone.'"
  [confirmButtonText]="'Delete'"
  [cancelButtonText]="'Cancel'"
  [isDangerous]="true"
></app-confirm-popup>