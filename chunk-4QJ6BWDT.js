import{b as m,c as i,d as b,e as y,f as l,i as I,j as f,k as g,l as W,m as v,q as E,t as O,u as D,v as M}from"./chunk-RJHESVFE.js";import{A as T,Sc as h,W as p,_ as c,g as F,ya as d}from"./chunk-UAHZMN6X.js";import{Ra as x,T as B,V as L,ab as u,bb as z,ia as R,ja as q,za as N}from"./chunk-CSZLD3FT.js";import{a as U,b as j,i as P,k as r}from"./chunk-BI7C37SH.js";z();E();var S=class n{constructor(e){this.platformId=e;if(this.isBrowser=h(this.platformId),this.isBrowser){let{firebaseApp:t}=(D(),P(O));this.db=b(t)}}isBrowser;db=null;getUserData(e){return r(this,null,function*(){if(this.db){let t=i(this.db,"users",e);return I(t).then(s=>{if(s.exists())return s.data();throw new Error("User not found")})}else return console.warn("Firestore not available in SSR"),Promise.resolve({})})}createUser(e){return r(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}yield g(i(this.db,"users",e.id),e)})}getUserById(e){return r(this,null,function*(){try{if(!this.isBrowser||!this.db)return null;let t=yield I(i(this.db,"users",e));return t.exists()?U({id:t.id},t.data()):null}catch(t){return console.error("Error obteniendo usuario por ID:",t),null}})}updateUser(e,t){return r(this,null,function*(){try{if(!this.isBrowser||!this.db)throw new Error("No se puede actualizar usuario en el servidor");yield g(i(this.db,"users",e),j(U({},t),{lastUpdated:new Date().getTime()}),{merge:!0}),console.log("Usuario actualizado exitosamente:",e)}catch(s){throw console.error("Error actualizando usuario:",s),s}})}getAllUsers(){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),[];try{let e=yield f(m(this.db,"users")),t=[];return e.forEach(s=>{let o=s.data();o.id=s.id,t.push(o)}),t}catch(e){return console.error("Error getting all users:",e),[]}})}deleteUser(e){return r(this,null,function*(){try{if(!this.isBrowser||!this.db)throw new Error("No se puede eliminar usuario en el servidor");yield v(i(this.db,"users",e)),console.log("Usuario eliminado exitosamente:",e)}catch(t){throw console.error("Error eliminando usuario:",t),t}})}static \u0275fac=function(t){return new(t||n)(c(d))};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};E();var A=class n{constructor(e){this.platformId=e;if(this.isBrowser=h(this.platformId),this.isBrowser){let{firebaseApp:t}=(D(),P(O));this.db=b(t)}}isBrowser;db=null;createAccount(e){return r(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}yield g(i(this.db,"accounts",e.id),e)})}getUserAccounts(e){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;let t=m(this.db,"accounts"),s=y(t,l("userId","==",e)),o=yield f(s),a=[];return o.forEach(w=>{a.push(w.data())}),a.length>0?a:null})}getAllAccounts(){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;let e=m(this.db,"accounts"),t=yield f(e),s=[];return t.forEach(o=>{s.push(o.data())}),s.length>0?s:null})}checkEmailExists(e,t){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),!1;let s=m(this.db,"accounts"),o=y(s,l("emailTradingAccount","==",e),l("userId","!=",t));return!(yield f(o)).empty})}checkAccountIdExists(e,t){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),!1;let s=m(this.db,"accounts"),o=y(s,l("accountID","==",e),l("userId","!=",t));return!(yield f(o)).empty})}updateAccount(e,t){return r(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}let s=i(this.db,"accounts",e);yield W(s,{accountName:t.accountName,broker:t.broker,server:t.server,emailTradingAccount:t.emailTradingAccount,brokerPassword:t.brokerPassword,accountID:t.accountID,accountNumber:t.accountNumber,balance:t.balance})})}deleteAccount(e){return r(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}let t=i(this.db,"accounts",e);yield v(t)})}validateAccountUniqueness(e,t,s){return r(this,null,function*(){try{let[o,a]=yield Promise.all([this.checkEmailExists(e,s),this.checkAccountIdExists(t,s)]);return o||a?{isValid:!1,message:"This account is already registered, try with another account or delete this trade account first"}:{isValid:!0,message:"Account creation/update successful"}}catch(o){return console.error("Error validating account uniqueness:",o),{isValid:!1,message:"Error validating account uniqueness"}}})}checkAccountExists(e,t,s,o){return r(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),!1;try{let a=m(this.db,"accounts"),w=y(a,l("broker","==",e),l("server","==",t),l("accountID","==",s),l("userId","!=",o));return!(yield f(w)).empty}catch(a){return console.error("Error checking account existence:",a),!1}})}static \u0275fac=function(t){return new(t||n)(c(d))};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};E();var k=class n{constructor(e){this.platformId=e;if(this.isBrowser=h(this.platformId),this.isBrowser){let{firebaseApp:t}=(D(),P(O));this.db=b(t)}}isBrowser;db=null;createLinkToken(e){return r(this,null,function*(){if(this.db)yield g(i(this.db,"tokens",e.id),e);else{console.warn("Firestore not available in SSR");return}})}deleteLinkToken(e){return r(this,null,function*(){if(this.db)yield v(i(this.db,"tokens",e));else{console.warn("Firestore not available in SSR");return}})}static \u0275fac=function(t){return new(t||n)(c(d))};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};var V=class n{constructor(e,t,s,o,a){this.platformId=e;this.usersOperationsService=t;this.accountsOperationsService=s;this.tokensOperationsService=o;this.appContext=a;this.isBrowser=h(this.platformId),this.isBrowser?N(u(),w=>{this.authStateSubject.next(w!==null)}):this.authStateSubject.next(!1)}isBrowser;authStateSubject=new F(null);authStateChanged=this.authStateSubject.asObservable();getAuth(){return u()}register(e){return R(u(),e.email,e.password)}login(e){return q(u(),e.email,e.password)}loginWithGoogle(){let e=new L;return x(u(),e)}loginWithApple(){let e=new B("apple.com");return x(u(),e)}logout(){return u().signOut()}sendPasswordReset(e){return r(this,null,function*(){let{sendPasswordResetEmail:t}=yield import("./chunk-SKBUADNM.js");return t(u(),e)})}isAuthenticated(){return this.authStateSubject.asObservable().pipe(T(e=>e!==null))}getCurrentUser(){try{return this.isBrowser?u().currentUser:null}catch(e){return console.error("Error obteniendo usuario actual:",e),null}}getBearerTokenFirebase(e){return r(this,null,function*(){let t=yield u().currentUser?.getIdToken();if(!t)throw new Error("Token not found");return t})}getUserData(e){return r(this,null,function*(){this.appContext.setLoading("user",!0),this.appContext.setError("user",null);try{let t=yield this.usersOperationsService.getUserData(e);return this.appContext.setCurrentUser(t),this.appContext.setLoading("user",!1),t}catch(t){throw this.appContext.setLoading("user",!1),this.appContext.setError("user","Error al obtener datos del usuario"),t}})}getUserById(e){return r(this,null,function*(){return this.usersOperationsService.getUserById(e)})}updateUser(e,t){return r(this,null,function*(){return this.usersOperationsService.updateUser(e,t)})}createUser(e){return r(this,null,function*(){return this.usersOperationsService.createUser(e)})}createLinkToken(e){return r(this,null,function*(){return this.tokensOperationsService.createLinkToken(e)})}deleteLinkToken(e){return r(this,null,function*(){return this.tokensOperationsService.deleteLinkToken(e)})}deleteUser(e){return r(this,null,function*(){return this.usersOperationsService.deleteUser(e)})}createAccount(e){return r(this,null,function*(){this.appContext.setLoading("accounts",!0),this.appContext.setError("accounts",null);try{yield this.accountsOperationsService.createAccount(e),this.appContext.addAccount(e),this.appContext.setLoading("accounts",!1)}catch(t){throw this.appContext.setLoading("accounts",!1),this.appContext.setError("accounts","Error al crear cuenta"),t}})}getUserAccounts(e){return r(this,null,function*(){this.appContext.setLoading("accounts",!0),this.appContext.setError("accounts",null);try{let t=yield this.accountsOperationsService.getUserAccounts(e);return this.appContext.setUserAccounts(t||[]),this.appContext.setLoading("accounts",!1),t}catch(t){throw this.appContext.setLoading("accounts",!1),this.appContext.setError("accounts","Error al obtener cuentas del usuario"),t}})}getAllAccounts(){return r(this,null,function*(){return this.accountsOperationsService.getAllAccounts()})}checkEmailExists(e,t){return r(this,null,function*(){return this.accountsOperationsService.checkEmailExists(e,t)})}checkAccountIdExists(e,t){return r(this,null,function*(){return this.accountsOperationsService.checkAccountIdExists(e,t)})}checkAccountExists(e,t,s,o){return r(this,null,function*(){return this.accountsOperationsService.checkAccountExists(e,t,s,o)})}updateAccount(e,t){return r(this,null,function*(){return this.accountsOperationsService.updateAccount(e,t)})}deleteAccount(e){return r(this,null,function*(){return this.accountsOperationsService.deleteAccount(e)})}static \u0275fac=function(t){return new(t||n)(c(d),c(S),c(A),c(k),c(M))};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};export{V as a};
