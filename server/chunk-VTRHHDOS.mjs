import './polyfills.server.mjs';
import{a as v,b as f,c as s,d as x,e as h,f as d,h as I,i as p,j as C,k as P,l,m as D,n as R,q as B,t as q,u as L,v as A}from"./chunk-YWJXSM6M.mjs";import{W as m,_ as S,ld as F,za as E}from"./chunk-YCCZPWYV.mjs";import{a as y,b as w,i as _,k as i}from"./chunk-H4UZCO6D.mjs";B();B();var O=class u{constructor(r){this.platformId=r;if(this.isBrowser=F(this.platformId),this.isBrowser){let{firebaseApp:t}=(L(),_(q));this.db=x(t)}}isBrowser;db=null;createConfigurationOverview(r,t){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),"";let e=this.generateOverviewId(),n=v.now(),a={userId:r,name:t,status:!1,created_at:n,updated_at:n,days_active:0,configurationId:""};return yield P(s(this.db,"configuration-overview",e),a),e})}getConfigurationOverview(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=s(this.db,"configuration-overview",r),e=yield p(t);if(e.exists()){let n=e.data();return n.id=e.id,n}return null}catch(t){return console.error("Error getting configuration overview:",t),null}})}updateConfigurationOverview(r,t){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}let e=s(this.db,"configuration-overview",r),n=w(y({},t),{updated_at:v.now()});yield l(e,n)})}deleteConfigurationOverview(r){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}let t=s(this.db,"configuration-overview",r);yield D(t)})}createConfiguration(r,t,e){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}let n=w(y({},e),{configurationOverviewId:t,userId:r});yield P(s(this.db,"configurations",r),n)})}getConfiguration(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=s(this.db,"configurations",r),e=yield p(t);return e.exists()?e.data():null}catch(t){return console.error("Error getting configuration:",t),null}})}updateConfiguration(r,t){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}yield l(s(this.db,"configurations",r),t)})}createConfigurationOnly(r){return i(this,null,function*(){if(!this.db)throw console.warn("Firestore not available in SSR"),new Error("Firestore not available");try{return(yield R(f(this.db,"configurations"),r)).id}catch(t){throw console.error("Error creating configuration:",t),t}})}createConfigurationOverviewWithConfigId(r,t,e,n=!1){return i(this,null,function*(){if(!this.db)throw console.warn("Firestore not available in SSR"),new Error("Firestore not available");try{let a=new Date,o={userId:r,name:t,status:n,created_at:a,updated_at:a,days_active:0,configurationId:e,dateActive:[a]};return(yield R(f(this.db,"configuration-overview"),o)).id}catch(a){throw console.error("Error creating configuration overview:",a),a}})}updateConfigurationById(r,t){return i(this,null,function*(){if(!this.db)throw console.warn("Firestore not available in SSR"),new Error("Firestore not available");try{let e=s(this.db,"configurations",r);yield l(e,t)}catch(e){throw console.error("Error updating configuration by ID:",e),e}})}getConfigurationById(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=s(this.db,"configurations",r),e=yield p(t);return e.exists()?e.data():null}catch(t){return console.error("Error getting configuration by ID:",t),null}})}getConfigurationByOverviewId(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=h(f(this.db,"configurations"),d("configurationOverviewId","==",r),I(1)),e=yield C(t);return e.empty?null:e.docs[0].data()}catch(t){return console.error("Error getting configuration by overview ID:",t),null}})}getUserStrategyViews(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),[];try{let t=h(f(this.db,"configuration-overview"),d("userId","==",r)),e=yield C(t),n=[];return e.forEach(a=>{let o=a.data();o.id=a.id,n.push(o)}),n.sort((a,o)=>{let g=a.updated_at.toDate();return o.updated_at.toDate().getTime()-g.getTime()}),n}catch(t){return console.error("\u274C Error getting user strategies:",t),[]}})}getActiveConfiguration(r){return i(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=h(f(this.db,"configuration-overview"),d("userId","==",r),d("status","==",!0),I(1)),e=yield C(t);if(!e.empty){let n=e.docs[0],a=n.data();return a.id=n.id,a}return null}catch(t){return console.error("Error getting active configuration:",t),null}})}activateStrategyView(r,t){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}try{let e=h(f(this.db,"configuration-overview"),d("userId","==",r),d("status","==",!0)),n=yield C(e),a=[];n.forEach(o=>{a.push(l(o.ref,{status:!1}))}),a.push(l(s(this.db,"configuration-overview",t),{status:!0,updated_at:v.now()})),yield Promise.all(a)}catch(e){throw console.error("Error activating strategy:",e),e}})}updateStrategyDates(r,t,e,n){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}try{let a=s(this.db,"configuration-overview",t),o=yield p(a);if(!o.exists())throw new Error("Strategy not found");let g=o.data(),c={};if(e!=null){let b=[...g.dateActive||[],v.fromDate(e)];c.dateActive=b,c.status=!0}if(n!=null){let b=[...g.dateInactive||[],v.fromDate(n)];c.dateInactive=b,c.status=!1}Object.keys(c).length>0&&(c.updated_at=v.now(),yield l(a,c))}catch(a){throw console.error("Error updating strategy dates:",a),a}})}deleteStrategyView(r){return i(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}try{let t=yield this.getConfigurationOverview(r);if(!t)throw new Error("Strategy not found");if(yield this.deleteConfigurationOverview(r),t.configurationId)try{let e=s(this.db,"configurations",t.configurationId);yield D(e)}catch(e){console.warn("Configuration not found for deletion:",e)}}catch(t){throw console.error("Error deleting strategy:",t),t}})}generateOverviewId(){return"overview_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}static \u0275fac=function(t){return new(t||u)(S(E))};static \u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"})};var V=class u{constructor(r,t){this.strategyOperationsService=r;this.appContext=t}createConfigurationOverview(r,t){return i(this,null,function*(){return this.strategyOperationsService.createConfigurationOverview(r,t)})}getConfigurationOverview(r){return i(this,null,function*(){return this.strategyOperationsService.getConfigurationOverview(r)})}updateConfigurationOverview(r,t){return i(this,null,function*(){return this.strategyOperationsService.updateConfigurationOverview(r,t)})}deleteConfigurationOverview(r){return i(this,null,function*(){return this.strategyOperationsService.deleteConfigurationOverview(r)})}createConfiguration(r,t,e){return i(this,null,function*(){return this.strategyOperationsService.createConfiguration(r,t,e)})}getConfiguration(r){return i(this,null,function*(){return this.strategyOperationsService.getConfiguration(r)})}updateConfiguration(r,t){return i(this,null,function*(){return this.strategyOperationsService.updateConfiguration(r,t)})}createConfigurationOnly(r){return i(this,null,function*(){return this.strategyOperationsService.createConfigurationOnly(r)})}createConfigurationOverviewWithConfigId(r,t,e,n=!1){return i(this,null,function*(){return this.strategyOperationsService.createConfigurationOverviewWithConfigId(r,t,e,n)})}updateConfigurationById(r,t){return i(this,null,function*(){return this.strategyOperationsService.updateConfigurationById(r,t)})}createStrategyView(r,t,e,n=!1){return i(this,null,function*(){this.appContext.setLoading("strategies",!0),this.appContext.setError("strategies",null);try{let a=yield this.createConfigurationOnly(e),o=yield this.createConfigurationOverviewWithConfigId(r,t,a,n),g=yield this.getConfigurationOverview(o);return g&&this.appContext.addStrategy(w(y({},g),{id:o})),this.appContext.setLoading("strategies",!1),o}catch(a){throw this.appContext.setLoading("strategies",!1),this.appContext.setError("strategies","Error al crear estrategia"),a}})}getStrategyView(r){return i(this,null,function*(){let t=yield this.getConfigurationOverview(r);if(!t)return null;let e=yield this.getConfigurationById(t.configurationId);return e?{overview:t,configuration:e}:null})}getConfigurationById(r){return i(this,null,function*(){return this.strategyOperationsService.getConfigurationById(r)})}getConfigurationByOverviewId(r){return i(this,null,function*(){return this.strategyOperationsService.getConfigurationByOverviewId(r)})}updateStrategyView(r,t){return i(this,null,function*(){if(t.name&&(yield this.updateConfigurationOverview(r,{name:t.name})),t.configuration){let e=yield this.getConfigurationOverview(r);e&&e.configurationId&&(yield this.updateConfigurationById(e.configurationId,t.configuration))}})}getUserStrategyViews(r){return i(this,null,function*(){this.appContext.setLoading("strategies",!0),this.appContext.setError("strategies",null);try{let t=yield this.strategyOperationsService.getUserStrategyViews(r);return this.appContext.setUserStrategies(t),this.appContext.setLoading("strategies",!1),t}catch(t){throw this.appContext.setLoading("strategies",!1),this.appContext.setError("strategies","Error al obtener estrategias del usuario"),t}})}getActiveConfiguration(r){return i(this,null,function*(){return this.strategyOperationsService.getActiveConfiguration(r)})}getStrategyConfig(r){return i(this,null,function*(){return yield this.getConfiguration(r)})}saveStrategyConfig(r,t){return i(this,null,function*(){console.warn("saveStrategyConfig is deprecated. Use createConfiguration instead.")})}activateStrategyView(r,t){return i(this,null,function*(){return this.strategyOperationsService.activateStrategyView(r,t)})}updateStrategyDates(r,t,e,n){return i(this,null,function*(){return this.strategyOperationsService.updateStrategyDates(r,t,e,n)})}deleteStrategyView(r){return i(this,null,function*(){return this.strategyOperationsService.deleteStrategyView(r)})}static \u0275fac=function(t){return new(t||u)(S(O),S(A))};static \u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"})};export{V as a};
