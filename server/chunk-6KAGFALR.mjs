import './polyfills.server.mjs';
import{a as f}from"./chunk-ZQTEKPLK.mjs";import{a as b,b as A}from"./chunk-PUENJBJ5.mjs";import{q as g}from"./chunk-5EV7JWWV.mjs";import{$ as i,B as d,Q as m,W as p,n as u,zd as h}from"./chunk-YCCZPWYV.mjs";import{k as r}from"./chunk-H4UZCO6D.mjs";var k=class l{subscriptionService=i(b);planService=i(A);store=i(h);router=i(g);canActivate(){return this.store.select(f).pipe(m(a=>r(this,null,function*(){let t=a?.user;if(!t?.id)return!1;let e=yield this.checkUserLimitations(t.id);return e.isActive&&!e.needsSubscription})),d(()=>u(!1)))}checkUserLimitations(a){return r(this,null,function*(){try{let t=yield this.subscriptionService.getAllSubscriptionsByUserId(a);if(!t||t.length===0)return{maxAccounts:0,maxStrategies:0,planName:"No Plan",isActive:!1,isBanned:!1,isCancelled:!1,needsSubscription:!0};let e=t[0],s=e.status==="banned",n=e.status==="cancelled",o=e.status==="purchased"||e.status==="created"||e.status==="processing"||e.status==="active";if(s||n||!o)return{maxAccounts:0,maxStrategies:0,planName:"Inactive Plan",isActive:!1,isBanned:s,isCancelled:n,needsSubscription:!0};let c=yield this.planService.getPlanById(e.planId);if(!c)return{maxAccounts:0,maxStrategies:0,planName:"Unknown Plan",isActive:!1,isBanned:!1,isCancelled:!1,needsSubscription:!0};let M=c.tradingAccounts||1,v=c.strategies||1;return{maxAccounts:M,maxStrategies:v,planName:c.name,isActive:!0,isBanned:!1,isCancelled:!1,needsSubscription:!1}}catch(t){return console.error("Error checking user limitations:",t),{maxAccounts:0,maxStrategies:0,planName:"Error",isActive:!1,isBanned:!1,isCancelled:!1,needsSubscription:!0}}})}checkAccountCreation(a,t){return r(this,null,function*(){let e=yield this.checkUserLimitations(a);return e.needsSubscription||e.isBanned||e.isCancelled?{canCreate:!1,showBlockedModal:!0,blockedMessage:this.getBlockedMessage(e),showUpgradeModal:!1,upgradeMessage:""}:t>=e.maxAccounts?{canCreate:!1,showUpgradeModal:!0,upgradeMessage:`You've reached the account limit for your ${e.planName} plan. Move to a higher plan and keep growing your account.`,showBlockedModal:!1,blockedMessage:""}:{canCreate:!0,showUpgradeModal:!1,upgradeMessage:"",showBlockedModal:!1,blockedMessage:""}})}checkStrategyCreation(a,t){return r(this,null,function*(){let e=yield this.checkUserLimitations(a);return e.needsSubscription||e.isBanned||e.isCancelled?{canCreate:!1,showBlockedModal:!0,blockedMessage:this.getBlockedMessage(e),showUpgradeModal:!1,upgradeMessage:""}:t>=e.maxStrategies?{canCreate:!1,showUpgradeModal:!0,upgradeMessage:`You've reached the strategy limit for your ${e.planName} plan. Move to a higher plan and keep growing your account.`,showBlockedModal:!1,blockedMessage:""}:{canCreate:!0,showUpgradeModal:!1,upgradeMessage:"",showBlockedModal:!1,blockedMessage:""}})}getBlockedMessage(a){return a.isBanned?"Your account has been banned. Please contact support for assistance.":a.isCancelled?"Your subscription has been cancelled. Please purchase a plan to access this functionality.":a.needsSubscription?"You need to purchase a plan to access this functionality.":"Access denied. Please contact support for assistance."}navigateToAccount(){this.router.navigate(["/account"])}navigateToSignup(){this.router.navigate(["/signup"])}checkFeatureAccess(a,t,e){return r(this,null,function*(){try{let s=yield this.checkUserLimitations(a);if(s.needsSubscription||s.isBanned||s.isCancelled)return{canAccess:!1,modalData:{showModal:!0,modalType:"blocked",title:"Access Restricted",message:this.getBlockedMessage(s),primaryButtonText:"Go to Account",onPrimaryAction:()=>this.navigateToAccount()}};let n=0,o="";switch(t){case"accounts":n=s.maxAccounts,o="trading accounts";break;case"strategies":n=s.maxStrategies,o="strategies";break;case"reports":return{canAccess:!0}}return e!==void 0&&e>=n?{canAccess:!1,modalData:{showModal:!0,modalType:"upgrade",title:"Upgrade Required",message:`You've reached the ${o} limit for your ${s.planName} plan. Move to a higher plan and keep growing your account.`,primaryButtonText:"Upgrade Plan",secondaryButtonText:"Cancel",onPrimaryAction:()=>this.navigateToAccount(),onSecondaryAction:()=>{}}}:{canAccess:!0}}catch(s){return console.error("Error checking feature access:",s),{canAccess:!1,modalData:{showModal:!0,modalType:"blocked",title:"Access Restricted",message:"An error occurred while checking your access. Please try again.",primaryButtonText:"Go to Account",onPrimaryAction:()=>this.navigateToAccount()}}}})}checkAccountCreationWithModal(a,t){return r(this,null,function*(){let e=yield this.checkFeatureAccess(a,"accounts",t);return{canCreate:e.canAccess,modalData:e.modalData}})}checkStrategyCreationWithModal(a,t){return r(this,null,function*(){let e=yield this.checkFeatureAccess(a,"strategies",t);return{canCreate:e.canAccess,modalData:e.modalData}})}checkReportAccessWithModal(a){return r(this,null,function*(){return this.checkFeatureAccess(a,"reports")})}static \u0275fac=function(t){return new(t||l)};static \u0275prov=p({token:l,factory:l.\u0275fac,providedIn:"root"})};export{k as a};
