import './polyfills.server.mjs';
import{f,g as U}from"./chunk-5EV7JWWV.mjs";import{b as A,c as g,d as q,e as C,f as T,g as O,h as H,i as S,k as W,m as z,q as tt,t as et,u as rt,v as K}from"./chunk-YWJXSM6M.mjs";import{Q as G,W as b,_ as h,ld as N,s as y,za as E}from"./chunk-YCCZPWYV.mjs";import{a as $,b as j,i as Z,k as p}from"./chunk-H4UZCO6D.mjs";function J(r){return{id:r[0],tradableInstrumentId:r[1],routeId:r[2],qty:r[3],side:r[4],type:r[5],status:r[6],filledQty:r[7],avgPrice:r[8],price:r[9],stopPrice:r[10],validity:r[11],expireDate:r[12],createdDate:r[13],lastModified:r[14],isOpen:r[15],positionId:r[16],stopLoss:r[17],stopLossType:r[18],takeProfit:r[19],takeProfitType:r[20],strategyId:r[21]}}function V(r,e,t,o){return p(this,null,function*(){let i=r.filter(u=>u.status!=="cancelled").map((u,l)=>j($({},u),{instrument:void 0,pnl:0,isWon:!1,isOpen:u.isOpen!=="false"})),n={};i.forEach(u=>{let l=u.positionId;n[l]||(n[l]=[]),n[l].push(u)});let a=yield nt(i,e,t,o),c=[],v=0,I=0;return Object.values(n).forEach(u=>{let l=u.find(m=>m.isOpen===!0),d=u.find(m=>m.isOpen===!1);if(l&&d)if(l.side&&d.side){let m=!1;if(l.side==="sell"&&d.side==="buy"){let F=Number(l.price),B=Number(d.price);m=F>B}else if(l.side==="buy"&&d.side==="sell"){let F=Number(l.price);m=Number(d.price)>F}let X=`${l.tradableInstrumentId}-${l.routeId}`,R=a.get(X),D=R?.lotSize||1;R?.name&&(l.instrument=R.name);let P=Number(l.price),L=Number(d.price),x=Number(l.qty),w;l.side==="buy"&&d.side==="sell"?w=(L-P)*(x*D):l.side==="sell"&&d.side==="buy"?w=(P-L)*(x*D):w=(L-P)*(x*D),l.isWon=m,l.isOpen=!1,l.pnl=w,c.push(l),m?v++:I++}else c.push(...u);else c.push(...u)}),c})}function nt(r,e,t,o){return p(this,null,function*(){let s=new Map;r.forEach(n=>{if(n.tradableInstrumentId&&n.routeId){let a=`${n.tradableInstrumentId}-${n.routeId}`;s.has(a)||s.set(a,{tradableInstrumentId:n.tradableInstrumentId,routeId:n.routeId})}});let i=new Map;for(let[n,a]of s)try{let c=yield e.getInstrumentDetails(t,a.tradableInstrumentId,a.routeId,o).toPromise(),v=c.lotSize,I=c.name;i.set(n,{lotSize:v,name:I}),yield new Promise(u=>setTimeout(u,100))}catch(c){console.error(`\u274C Error querying instrument ${n}:`,c),i.set(n,{lotSize:1,name:a.tradableInstrumentId})}return i})}function it(r){let e=r.reduce((t,o)=>t+(o.pnl??0),0);return Math.round(e)}function at(r){let e=r.filter(t=>t.pnl!==void 0&&t.pnl>0).length;return r.length>0?Math.round(e/r.length*100):0}function lt(r){let e=r.filter(s=>(s.pnl??0)>0).reduce((s,i)=>s+i.pnl,0),t=r.filter(s=>(s.pnl??0)<0).reduce((s,i)=>s+Math.abs(i.pnl),0);if(t===0)return e>0?999.99:0;let o=e/t;return Math.round(o*100)/100}function ct(r){let e=r.filter(a=>a.pnl!==void 0&&a.pnl>0),t=r.filter(a=>a.pnl!==void 0&&a.pnl<0);if(t.length===0)return e.length>0?999.99:0;let o=e.reduce((a,c)=>a+c.pnl,0),s=t.reduce((a,c)=>a+Math.abs(c.pnl),0),i=e.length>0?o/e.length:0,n=t.length>0?s/t.length:0;return n>0?Math.round(i/n*100)/100:0}function pt(r){return r.length}var mt=r=>{if(!r||r.length===0)return null;let e=r.reduce((t,o)=>o.pnl===void 0?t:t.pnl===void 0||o.pnl>t.pnl?o:t,r[0]);return Math.round(e.pnl??0)},ht=r=>{let e=r.reduce((t,o)=>{let s=Number(o.price)||0,i=Number(o.qty)||0;return t+s*i},0);return Math.floor(e)};function _(r,e,t){let o=e.toString().padStart(2,"0");return`${r}-${o}-${t}`}var M=class r{constructor(e){this.http=e}baseUrl="https://demo.tradelocker.com/backend-api";getJWTToken(e){let t=`${this.baseUrl}/auth/jwt/token`,o=new f({"Content-Type":"application/json"}),s={email:e.email,password:e.password,server:e.server};return this.http.post(t,s,{headers:o})}validateAccount(e){return p(this,null,function*(){try{let t=yield this.getJWTToken(e).toPromise();return!!(t&&t.accessToken)}catch(t){return console.error("Error validating account in TradeLocker:",t),!1}})}getAccountBalance(e,t,o){let s=`${this.baseUrl}/trade/accounts/${e}/state`,i=new f({"Content-Type":"application/json",Authorization:`Bearer ${t}`,accNum:o.toString()});return this.http.get(s,{headers:i})}getTradingHistory(e,t,o){let s=`${this.baseUrl}/trade/accounts/${t}/ordersHistory`,i=new f({"Content-Type":"application/json",Authorization:`Bearer ${e}`,accNum:o.toString()});return this.http.get(s,{headers:i})}getUserKey(e,t,o){let s={email:e,password:t,server:o};return this.getJWTToken(s).pipe(y(i=>i.accessToken))}getInstrumentDetails(e,t,o,s){let i=`${this.baseUrl}/trade/instruments/${t}`,n=new f({"Content-Type":"application/json",Authorization:`Bearer ${e}`,accNum:s.toString()}),a={routeId:o};return this.http.get(i,{headers:n,params:a})}getAllInstruments(e,t,o){let s=`${this.baseUrl}/trade/accounts/${t}/instruments`,i=new f({"Content-Type":"application/json",Authorization:`Bearer ${e}`,accNum:o.toString()});return this.http.get(s,{headers:i})}static \u0275fac=function(t){return new(t||r)(h(U))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};tt();var k=class r{constructor(e){this.platformId=e;if(this.isBrowser=N(this.platformId),this.isBrowser){let{firebaseApp:t}=(rt(),Z(et));this.db=q(t)}}isBrowser;db=null;updateMonthlyReport(e){return p(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}try{let t=_(e.id,e.month,e.year);yield W(g(this.db,"monthly_reports",t),e)}catch(t){throw console.error("Error updating monthly report:",t),t}})}getMonthlyReport(e){return p(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let t=g(this.db,"monthly_reports",e),o=yield S(t);return o.exists()?o.data():null}catch(t){return console.error("Error getting monthly report:",t),null}})}getAllMonthlyReports(){return p(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),[];try{let e=yield S(g(this.db,"monthly_reports")),t=[];return e.data()?.forEach(o=>{let s=o.data();s.id=o.id,t.push(s)}),t}catch(e){return console.error("Error getting all monthly reports:",e),[]}})}getMonthlyReportsByUserId(e){return p(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),[];try{let t=C(A(this.db,"monthly_reports"),T("userId","==",e),O("year","desc"),O("month","desc")),o=yield S(g(this.db,"monthly_reports")),s=[];return o.data()?.forEach(i=>{let n=i.data();n.id=i.id,s.push(n)}),s}catch(t){return console.error("Error getting monthly reports by user ID:",t),[]}})}getMonthlyReportByUserMonthYear(e,t,o){return p(this,null,function*(){if(!this.db)return console.warn("Firestore not available in SSR"),null;try{let s=C(A(this.db,"monthly_reports"),T("userId","==",e),T("month","==",t),T("year","==",o),H(1)),i=yield S(g(this.db,"monthly_reports"));if(i.exists()){let n=i.data()?.[0],a=n.data();return a.id=n.id,a}return null}catch(s){return console.error("Error getting monthly report by user, month and year:",s),null}})}deleteMonthlyReport(e){return p(this,null,function*(){if(!this.db){console.warn("Firestore not available in SSR");return}try{yield z(g(this.db,"monthly_reports",e))}catch(t){throw console.error("Error deleting monthly report:",t),t}})}static \u0275fac=function(t){return new(t||r)(h(E))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var Q=class r{constructor(e,t,o){this.tradeLockerApiService=e;this.monthlyReportsService=t;this.appContext=o}updateMonthlyReport(e){return p(this,null,function*(){return this.monthlyReportsService.updateMonthlyReport(e)})}getUserKey(e,t,o){return this.tradeLockerApiService.getUserKey(e,t,o)}getHistoryData(e,t,o){return this.appContext.setLoading("report",!0),this.appContext.setError("report",null),this.tradeLockerApiService.getTradingHistory(t,e,o).pipe(G(s=>p(this,null,function*(){let i=s.d.ordersHistory.map(J),n=yield V(i,{getInstrumentDetails:(a,c,v,I)=>this.tradeLockerApiService.getInstrumentDetails(a,c,v,I)},t,o);return this.appContext.updateReportHistory(n),this.appContext.setLoading("report",!1),n})))}getBalanceData(e,t,o){return this.appContext.setLoading("report",!0),this.appContext.setError("report",null),this.tradeLockerApiService.getAccountBalance(e,t,o).pipe(y(s=>{let n=s.d.accountDetailsData,a={balance:n[0]||0,projectedBalance:n[1]||0,availableFunds:n[2]||0,blockedBalance:n[3]||0,cashBalance:n[4]||0,unsettledCash:n[5]||0,withdrawalAvailable:n[6]||0,stocksValue:n[7]||0,optionValue:n[8]||0,initialMarginReq:n[9]||0,maintMarginReq:n[10]||0,marginWarningLevel:n[11]||0,blockedForStocks:n[12]||0,stockOrdersReq:n[13]||0,stopOutLevel:n[14]||0,warningMarginReq:n[15]||0,marginBeforeWarning:n[16]||0,todayGross:n[17]||0,todayNet:n[18]||0,todayFees:n[19]||0,todayVolume:n[20]||0,todayTradesCount:n[21]||0,openGrossPnL:n[22]||0,openNetPnL:n[23]||0,positionsCount:n[24]||0,ordersCount:n[25]||0};return this.appContext.updateReportBalance(a),this.appContext.setLoading("report",!1),a}))}getInstrumentDetails(e,t,o,s){return this.tradeLockerApiService.getInstrumentDetails(e,t,o,s).pipe(y(i=>i.d))}getAllInstruments(e,t,o){return this.tradeLockerApiService.getAllInstruments(e,o,t).pipe(y(s=>s.d.instruments)).pipe(y(s=>s.map(i=>i)))}static \u0275fac=function(t){return new(t||r)(h(M),h(k),h(K))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};export{it as a,at as b,lt as c,ct as d,pt as e,M as f,mt as g,ht as h,Q as i};
